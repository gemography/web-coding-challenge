<?php

namespace CTRV\CommonBundle\Entity;

use CTRV\CommonBundle\DependencyInjection\Constants;

use Doctrine\ORM\EntityRepository;
use Doctrine\ORM\Mapping as ORM;


class CommentRepository extends EntityRepository
{
	
	/**
	 * retourne la liste de commnetaires d'agendas de la ville courante
	 */
	public function getAgendaComment ($city, $first, $last) {
		
		$qb = $this->createQueryBuilder("p")
		->select('p as comment')
		->from('CTRV\EventBundle\Entity\Event','a')
		->addSelect('a.title')
		->where("p.idEntity=a.id")
		->andwhere("p.typeEntity=?1")
		->andWhere("a.city=?2")
		->andWhere('a.isPrivate=?3')
		->andWhere('a.isRealtime=?4')
		->orderBy('p.date', 'DESC')
		->setParameter(1, Constants::TYPE_ENTIY_AGENDA)
		->setParameter(2, $city)
		->setParameter(3,false)
		->setParameter(4,false)
		->setFirstResult($first)
		->setMaxResults($last)
		;
		return $qb->getQuery()->getResult();
	}
	
	/**
	 * retourne le nombre de commnetaires d'agendas de la ville courante
	 */
	public function getAgendaCommentNumber($city) {
	
		$qb = $this->createQueryBuilder("p")
		->select("count(p)")
		->from('CTRV\EventBundle\Entity\Event','a')
		->where("p.idEntity=a.id")
		->andwhere("p.typeEntity=?1")
		->andWhere("a.city=?2")
		->andWhere('a.isPrivate=?3')
		->andWhere('a.isRealtime=?4')
		->orderBy('p.date', 'DESC')
		->setParameter(1, Constants::TYPE_ENTIY_AGENDA)
		->setParameter(2, $city)
		->setParameter(3,false)
		->setParameter(4,false)
		;
		return $qb->getQuery()->getSingleScalarResult();
	}
	
	/**
	 * retourne la liste de commnetaires d'événements de la ville courante
	 */
   public function getEventComment($city, $first, $last) {
   	
		$qb = $this->createQueryBuilder("p")
		->select('p as comment')
		->from('CTRV\EventBundle\Entity\Event','a')
		->addSelect('a.title')
		->where("p.idEntity=a.id")
		->andwhere("p.typeEntity=?1")
		->andWhere("a.city=?2")
		->andWhere('a.isPrivate=?3')
		->andWhere('a.isRealtime=?4')
		->orderBy('p.date', 'DESC')
		->setParameter(1, Constants::TYPE_ENTIY_EVENT)
		->setParameter(2, $city)
		->setParameter(3,false)
		->setParameter(4,true)
		->setFirstResult($first)
		->setMaxResults($last)
		;
		return $qb->getQuery()->getResult();
	}
	
	/**
	 * retourne le nombre de commnetaires d'événements de la ville courante
	 */
	public function getEventCommentNumber($city) {
	
		$qb = $this->createQueryBuilder("p")
		->select("count(p)")
		->from('CTRV\EventBundle\Entity\Event','a')
		->where("p.idEntity=a.id")
		->andwhere("p.typeEntity=?1")
		->andWhere("a.city=?2")
		->andWhere('a.isPrivate=?3')
		->andWhere('a.isRealtime=?4')
		->orderBy('p.date', 'DESC')
		->setParameter(1, Constants::TYPE_ENTIY_EVENT)
		->setParameter(2, $city)
		->setParameter(3,false)
		->setParameter(4,true)
		;
		return $qb->getQuery()->getSingleScalarResult();
	}
	
	/**
	 * retourne la liste de commnetaires de places de la ville courante
	 */   
   public function getPlaceComment($city, $first, $last) {
   	
		$qb = $this->createQueryBuilder("p")
		->select('p as comment')
		->from('CTRV\PlaceBundle\Entity\Place','a')
		->addSelect('a.title')
		->where("p.idEntity=a.id")
		->andwhere("p.typeEntity=?1")
		->andWhere("a.city=?2")
		->orderBy('p.date', 'DESC')
		->setParameter(1, Constants::TYPE_ENTIY_PLACE)
		->setParameter(2, $city)
		->setFirstResult($first)
		->setMaxResults($last)
		;
		return $qb->getQuery()->getResult();
	}
	
	/**
	 * retourne la liste de commnetaires de places de la ville courante
	 */
	public function getPlaceCommentNumber($city) {
	
		$qb = $this->createQueryBuilder("p")
		->select("count(p)")
		->from('CTRV\PlaceBundle\Entity\Place','a')
		->where("p.idEntity=a.id")
		->andwhere("p.typeEntity=?1")
		->andWhere("a.city=?2")
		->orderBy('p.date', 'DESC')
		->setParameter(1, Constants::TYPE_ENTIY_PLACE)
		->setParameter(2, $city)
		;
		return $qb->getQuery()->getSingleScalarResult();
	}
	
	/**
	 * Retourne la liste de tous les commentaires signalés des évenements de la ville courante
	 */
	public function getEventCommentAbuse($city, $first, $last){
		$qb= $this->createQueryBuilder("c")
		->select('c.id,a.entityId')
		->from('CTRV\CommonBundle\Entity\Abuse','a')
		->from('CTRV\EventBundle\Entity\Event','e')
		->addSelect('c.content,a.entityType, e.title')
		->where("a.entityId=c.id")
		->andWhere("c.idEntity=e.id")
		->andWhere("a.entityType=?1")
		->andWhere("e.city=?2")
		->orderBy('c.date','DESC')
		->setParameter(1,Constants::EVENT_COMMENT_ABUSE)
		->setParameter(2,$city)
		->groupBy('a.entityId')
		->setFirstResult($first)
		->setMaxResults($last)
		;
		return $qb->getQuery()->getResult();
	}
	
	/**
	 * Retourne le nombre de commentaires signalés des évenements de la ville courante
	 */
	public function getEventCommentAbuseNumber($city){
		$qb= $this->createQueryBuilder("c")
		->select ("count(DISTINCT a.entityId )")
		->from('CTRV\CommonBundle\Entity\Abuse','a')
		->from('CTRV\EventBundle\Entity\Event','e')
		->where("a.entityId=c.id")
		->andWhere("c.idEntity=e.id")
		->andWhere("a.entityType=?1")
		->andWhere("e.city=?2")
		->orderBy('c.date','DESC')
		->setParameter(1,Constants::EVENT_COMMENT_ABUSE)
		->setParameter(2,$city)
		;
		return $qb->getQuery()->getSingleScalarResult();
	}
	
	
	/**
	 * Retourne la liste de tous les abus sur les commentaires des places
	 */
	public function getPlaceCommentAbuse($city, $first, $last){
		$qb= $this->createQueryBuilder("c")
		->select('c.id')
		->from('CTRV\CommonBundle\Entity\Abuse','a')
		->from('CTRV\PlaceBundle\Entity\Place','p')
		->addSelect('c.content,a.entityType, p.title')
		->where("a.entityId=c.id")
		->andWhere("c.idEntity=p.id")
		->andWhere("a.entityType=?1")
		->andWhere("p.city=?2")
		->orderBy('c.date','DESC')
		->setParameter(1,Constants::PLACE_COMMENT_ABUSE)
		->setParameter(2,$city)
		->groupBy('a.entityId')
		->setFirstResult($first)
		->setMaxResults($last)
		;
		return $qb->getQuery()->getResult();
	}
	
	
	/**
	 * Retourne la liste de tous les abus sur les commentaires des places
	 */
	public function getPlaceCommentAbuseNumber($city){
		$qb= $this->createQueryBuilder("c")
		->select ("count(DISTINCT a.entityId )")
		->from('CTRV\CommonBundle\Entity\Abuse','a')
		->from('CTRV\PlaceBundle\Entity\Place','p')
		->where("a.entityId=c.id")
		->andWhere("c.idEntity=p.id")
		->andWhere("a.entityType=?1")
		->andWhere("p.city=?2")
		->orderBy('c.date','DESC')
		->setParameter(1,Constants::PLACE_COMMENT_ABUSE)
		->setParameter(2,$city)
		;
		return $qb->getQuery()->getSingleScalarResult();
	}
}