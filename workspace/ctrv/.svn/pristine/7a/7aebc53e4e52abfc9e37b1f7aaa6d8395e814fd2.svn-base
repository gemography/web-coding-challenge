<?php

namespace CTRV\CommonBundle\Entity;

use CTRV\CommonBundle\DependencyInjection\Constants;

use Doctrine\ORM\EntityRepository;
use Doctrine\ORM\Mapping as ORM;

/**
 * AbuseRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class AbuseRepository extends EntityRepository
{
	/**
	 * Retourne la liste de tous les abus
	 * @param unknown_type $city
	 */
	public function getAllAbuse($city, $first, $last){
        $qb= $this->createQueryBuilder("a")
        ->select('a.id,a.entityId')
        ->from('CTRV\CommonBundle\Entity\Comment','c')
        ->from('CTRV\FlowBundle\Entity\PublicMessage','pm')
        ->from('CTRV\EventBundle\Entity\Event','e')
        ->from('CTRV\PlaceBundle\Entity\Place','p')
        ->addSelect('c.content,a.entityType')
        ->where("(a.entityId=c.id) AND (e.city=?1 AND p.city=?1)")
        ->orWhere("a.entityId=pm.id AND pm.city=?1")
        ->orderBy('a.entityType','DESC')
        ->setParameter(1,$city)
        ->groupBy('a.entityId')
        ->setFirstResult($first)
        ->setMaxResults($last)
 ;
 return $qb->getQuery()->getResult();
}

/**
 * Retourne le nombre total d'abus
 * @param unknown_type $city
 */
public function getAllAbuseNumber($city){
	$qb= $this->createQueryBuilder("a")
	->select('a.id,a.entityId')
	->from('CTRV\CommonBundle\Entity\Comment','c')
	->from('CTRV\FlowBundle\Entity\PublicMessage','pm')
	->from('CTRV\EventBundle\Entity\Event','e')
	->from('CTRV\PlaceBundle\Entity\Place','p')
	->addSelect('c.content,a.entityType')
	->where("(a.entityId=c.id) AND (e.city=?1 AND p.city=?1)")
    ->orWhere("a.entityId=pm.id AND pm.city=?1")
	->orderBy('a.entityType','DESC')
	->setParameter(1,$city)
	->groupBy('a.entityId')
	;
	return count($qb->getQuery()->getResult());
}
}
