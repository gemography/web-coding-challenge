<?php

namespace CTRV\CommonBundle\Entity;

use Doctrine\ORM\EntityRepository;

use Doctrine\ORM\Mapping as ORM;


class UserRepository extends EntityRepository
{
	//retourne la liste des utilisateurs de la ville courante
	public function getUsers ($city) {
		$qb = $this->createQueryBuilder("p")
		->where("p.city=?1")
		->orderBy('p.registrationDate', 'DESC')
		->setParameter(1, $city)
		
		;
		return $qb->getQuery()->getResult();
	}
	//retourne la liste des utilisateurs connectés
	public function getUsersConnected () {
		$qb = $this->createQueryBuilder("p")
		->select ('p')
		->from('CTRV\CommonBundle\Entity\ConnectedUsers','a')
		->where("p.id=a.id")
		->orderBy('p.id', 'DESC')
		;
		return $qb->getQuery()->getResult();
	}
	//retourne la liste des utilisateurs connectés de la ville courante
	public function getUsersConnectedCity ($city) {
		$qb = $this->createQueryBuilder("p")
		->select ('p')
		->from('CTRV\CommonBundle\Entity\ConnectedUsers','a')
		->where("p.id=a.id")
		->andWhere("p.city=?1")
		->orderBy('p.id', 'DESC')
		->setParameter(1, $city)
		;
		return $qb->getQuery()->getResult();
	}
	//retourne la lsite de tous les utilisateurs
	public function getAllUsers () {
		$qb = $this->createQueryBuilder("p")
		->orderBy('p.registrationDate', 'DESC')
		;
		return $qb->getQuery()->getResult();
	}
	//desactiver un utilisateur
	public function desactiveUsers ($id) {
		$qb = Doctrine_Query::create()
        ->update('User')
        ->set('isActive', '0')
        ->where("id=?1")
		->setParameter(1, $id);
		return $qb->getSqlQuery();
	}
	//rechercher un utilisateur à partir d'un mot clé
	public function getRechercherUser(){
		$qb = $this->createQueryBuilder("a")
		->from("CTRV\CommonBundle\Entity\User")
		->where("a.firstName LIKE :motcle OR a.lastName LIKE :motcle")
		->orderBy('a.firstName','ASC')
		->setParameter('motcle','%'.$motcle.'%');
		return $qb->getQuery()->getResult();
	}
}