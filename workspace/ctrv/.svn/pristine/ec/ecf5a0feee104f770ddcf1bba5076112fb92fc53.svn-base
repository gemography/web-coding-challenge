<?php

namespace CTRV\CommonBundle\Controller;

use Doctrine\ORM\EntityRepository;

use Symfony\Component\HttpFoundation\Response;

use CTRV\CommonBundle\Entity\City;

use CTRV\CommonBundle\Entity\ChooseCityEntity;

use CTRV\CommonBundle\Form\ChooseCityType;

use Symfony\Bundle\FrameworkBundle\Controller\Controller;
use Sensio\Bundle\FrameworkExtraBundle\Configuration\Route;
use Sensio\Bundle\FrameworkExtraBundle\Configuration\Template;

class CommonController extends Controller
{
    /**
     * @Route("/",name="home")
     * @Template()
     */
    public function indexAction()
    {
        return array('name' => "man");
    }
    
    /**
     * Retourne le formulaire de choix d ville
     * @Template()
     */
    public function renderChooseCityFormAction () {
    	$form = $this->createForm(new ChooseCityType());
    	return array('form'=>$form->createView());
    }
    
    /**
     * Met la ville selectionnÃ©e en session
     * @Route("/session/city",name="city_session")
     * @param City $city
     */
    public function setCitySession () {
    	$city_id = $this->getRequest()->request->get("city_id");
    	$this->get('session_service')->setCity($city_id);
    	return new Response(json_encode(array('result'=>true)));
    }
    
    /**
     * Affiche les numeros de page
     * @param unknown_type $nb_pages
     * @param unknown_type $page
     * @param unknown_type $url_path
     */
    public function renderPaginationAction ($nb_pages, $page, $url_path,$href_active) {
    	return $this->render ('CTRVCommonBundle:common:pagination.html.twig',array(
    			'nb_pages'	=> $nb_pages,
    			'page'		=> $page,
    			'url_path'	=> $url_path,
    			'href_active'	=> $href_active
    	));
    }
    
    
    /**
     * Retourne le formulaire de choix de la ville
     */
    public function getChooseCityForm () {
    	 
    	return $this->createFormBuilder( array())
    	 ->add('choose_city', 'entity', array(
	        		'class' => 'CTRVCommonBundle:City',
	        		'query_builder' => function(EntityRepository $er) {
	        		return $er->createQueryBuilder('u')
	        		->orderBy('u.name', 'ASC');
	        		},
	        		'label'=>'common.chooseCity'
	     ))
    	->getForm()
    	;
    }
}
